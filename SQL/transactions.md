# Транзакции

Транзакция – это группа последовательных, неделимых операций с БД. Результаты транзакции должны быть либо полностью приняты, либо полностью отвергнуты.

Разберём примере транзакции в случае переводе 100 рублей с карты ABC на карту DEF:

- Прочитать баланс на карте номер ABC;
- Уменьшить баланс карты ABC на 100 рублей;
- Сохранить новый баланс карты ABC;
- Прочитать баланс карты DEF;
- Увеличить баланс карты DEF на 100 рублей;
- Сохранить новый баланс карты DEF.

Данные 6 пунктов являются подоперациями одной транзакции. Все эти действия должны представлять единое логическое действие и должны быть либо полностью все приняты, либо все отвергнуты. Иначе, может так получиться, что с карты ABC будет списано 100 рублей, а на карту DEF эти деньги зачислены не будут.

**Основной набор требований к транзакциям (ACID)**:

- Атомарность (Atomicity)
Гарантирует, что результаты всех подопераций транзакции будут либо полностью приняты, либо полностью отвергнуты.
- Согласованность (Consistency)
Каждая успешная транзакция должна фиксировать только допустимые/валидные данные. Допустимые значения должны быть описаны в бизнес правилах.
Пример: клиенту на счёт зачисляется 5 миллионов рублей, всё происходит успешно, но данный банк по своим правилам запрещает переводить клиентам своего банка более 1 миллиона рублей единоразово. Таким образом, несмотря на то, что все подоперации транзакции были выполнены успешно, её результаты должны быть отвергнуты, т.к. данная транзакция противоречит принципу согласованности.
- Изолированность (Isolation)
Параллельно выполняющиеся транзакции не должны влиять на результат выполнения друг друга. Это достаточно ресурсоёмкое требование, более подробно оно будет рассмотрено позже.
- Стойкость (Durability)	
Результаты транзакции должны быть сохранены независимо от проблем на других уровнях работы ПО (например, сбой в оборудовании). Т.е. если при переводе денег со счёта на счёт произошёл сбой оборудования, клиенты должны быть уверены, что перевод либо состоялся успешно (деньги были списаны со счёта A и зачислены на счёт B), либо не состоялся вообще (деньги со счёта A списаны не были).

**Операторы в транзакциях:**

- `COMMIT` - принимает все результаты транзакции;
- `ROLLBACK` - откатывает все результаты транзакции;
- `SAVEPOINT`  - позволяет  сохранять прогресс выполнения в ходе транзакции.
    
    Благодаря `SAVEPOINT` , в транзакции создаётся точка, до которой можно откатить транзакцию, не откатывая всю транзакцию целиком. На словах это немного противоречит принципу атомарности, но это не совсем так, потому что сам автор транзакции формирует эти точки, соглашаясь с тем, что эта часть транзакции будет считаться за целую. Т.е. `SAVEPOINT` помогает нам реализовывать частичное откатывание транзакций. Мы можем обернуть в большую транзакцию какую-то последовательность действий и расставить `SAVEPOINT`'ы в тех местах, в которых данные будут обновлены и согласованы. Также `SAVEPOINT` можно удалить с помощью команды `RELEASE SAVEPOINT`(обратите внимание, что все точки, которые были созданы после той, что была удалены - также будут удалены).
    

Также поддерживается функционал вложенных транзакций. В существующих транзакциях, тем же синтаксисом объявляется новая транзакция. Верхнеуровневая транзакция (может содержать несколько вложенных транзакций) ожидает окончания вложенных транзакций.

Нужно учитывать, что закоммитить, т.е. принять данные вложенных транзакций может только общая внешняя транзакция. Т.е. если все вложенные транзакции выполнили `COMMIT` , а потом был произведён `ROLLBACK` внешней транзакции, то результаты всех вложенных транзакций будут отменены. По сути, `COMMIT` вложенных транзакций - это не принятие результата этих транзакций, а просто подтверждение, что на данном этапе ничего плохого не случилось. Т.е. физически принять результат вложенных транзакций может только внешняя транзакция.

**Уровни изоляции транзакций**
Уровень изоляции транзакций - это степень допущения получения несогласованных данных.
Наиболее безопасный уровень является самым медленным. Таким образом, необходимо учитывать для каких целей идёт работа с БД и исходя из этого выбирать режим изоляции (наиболее производительный или наиболее безопасный и точный).

**Проблемы, возникающие при параллельном выполнении транзакций:**

- Потерянное обновление - при одновременном изменении какого-то поля разными транзакциями - теряются все изменения, кроме последнего (одно поле обновляют две транзакции, в итоге оно примет значение одной из них, потеряв изменение от другой);
- Грязное чтение - чтение данных, которые были добавлены или изменены транзакцией, которая откатится;
- Неповторяющееся чтение - ситуация, когда при повторном чтении в рамках одной транзакции ранее прочитанные данные оказываются изменёнными;
- Фантомное чтение - ситуация, когда при повторном чтении в рамках одной транзакции одна и та же выборка даёт разные множества строк (увеличилось количество строк).

**Уровни изоляции транзакций:**

- Чтение незафиксированных данных (read uncommited): решает только проблему потерянного обновления;
- Чтение зафиксированных данных (read commited): решает проблему потерянного обновления и грязного чтения;
- Повторяемое чтение (repeatable read): решает проблему потерянного обновления, грязного чтения, неповторяющегося чтения;
- Упорядочиваемость (serializable): решает проблемы потерянного обновления, грязного чтения, неповторяющегося чтения, фантомного чтения (все проблемы).